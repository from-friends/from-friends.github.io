<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Push Notifications</title>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "bd8092c4-a5c8-479c-92f8-7aec5aae0854",
          serviceWorkerParam: { scope: '/test/webpush/' },
          serviceWorkerPath: 'test/webpush/OneSignalSDK.sw.js',
        });
      });
    </script>
    <style>
        :root {
            --background-color: #121212;
            --text-color: #E0E0E0;
            --primary-color: #FF5722;
            --container-bg: #1E1E1E;
            --button-hover-bg: #ff7043;
            --success-color: #4CAF50;
            --error-color: #F44336;
            --warning-color: #FFC107;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            background-color: var(--container-bg);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: var(--text-color);
            margin-bottom: 1rem;
        }

        p {
            margin-bottom: 1.5rem;
        }

        .subscribe-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
            margin-bottom: 1.5rem;
        }

        .subscribe-button:hover {
            background-color: var(--button-hover-bg);
        }

        .subscribe-button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        #status {
            margin-top: 1.5rem;
            font-weight: bold;
        }

        .requirements {
            margin-top: 2rem;
            text-align: left;
            padding: 1rem;
            border: 1px solid #333;
            border-radius: 4px;
        }

        .requirements h2 {
            margin-top: 0;
            color: var(--primary-color);
        }
        
        .requirement {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .requirement-status {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 50%;
        }
        
        .status-success { background-color: var(--success-color); }
        .status-error { background-color: var(--error-color); }
        .status-warning { background-color: var(--warning-color); }
        .status-pending { background-color: #666; }

    </style>
</head>
<body>

    <div class="container">
        <h1>Stay Updated!</h1>
        <p>Subscribe to our push notifications to receive the latest news and updates directly on your device.</p>
        
        <button id="subscribeBtn" class="subscribe-button" disabled>Subscribe</button>

        <div id="status"></div>

        <div class="requirements">
            <h2>Prerequisites</h2>
            <div id="https-check" class="requirement">
                <div class="requirement-status status-pending"></div>
                <span>Site is on HTTPS</span>
            </div>
            <div id="sw-check" class="requirement">
                <div class="requirement-status status-pending"></div>
                <span>Service Worker is registered</span>
            </div>
            <div id="permission-check" class="requirement">
                <div class="requirement-status status-pending"></div>
                <span>Notification Permission</span>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const subscribeBtn = document.getElementById('subscribeBtn');
            const statusDiv = document.getElementById('status');
            
            const httpsCheck = document.getElementById('https-check').querySelector('.requirement-status');
            const swCheck = document.getElementById('sw-check').querySelector('.requirement-status');
            const permissionCheck = document.getElementById('permission-check').querySelector('.requirement-status');
            const permissionText = document.getElementById('permission-check').querySelector('span');

            function updateRequirementStatus(element, status) {
                element.classList.remove('status-pending', 'status-success', 'status-error', 'status-warning');
                element.classList.add(`status-${status}`);
            }

            function checkHttps() {
                if (window.location.protocol === 'https:') {
                    updateRequirementStatus(httpsCheck, 'success');
                    return true;
                } else {
                    updateRequirementStatus(httpsCheck, 'error');
                    httpsCheck.parentElement.querySelector('span').textContent += ' (not secure)';
                    return false;
                }
            }

            async function checkServiceWorker() {
                try {
                    const registration = await navigator.serviceWorker.getRegistration('/OneSignalSDKWorker.js');
                    if (registration && registration.active) {
                        updateRequirementStatus(swCheck, 'success');
                        return true;
                    } else {
                         // OneSignal SDK handles registration, we just check for it.
                        updateRequirementStatus(swCheck, 'warning');
                        swCheck.parentElement.querySelector('span').textContent += ' (pending registration)';
                        return false;
                    }
                } catch (e) {
                    updateRequirementStatus(swCheck, 'error');
                    swCheck.parentElement.querySelector('span').textContent += ' (failed to check)';
                    console.error('Service Worker check failed:', e);
                    return false;
                }
            }

            function checkNotificationPermission() {
                const permission = OneSignal.Notifications.permissionNative;
                permissionText.textContent = `Notification Permission: ${permission}`;
                if (permission === 'granted') {
                    updateRequirementStatus(permissionCheck, 'success');
                } else if (permission === 'denied') {
                    updateRequirementStatus(permissionCheck, 'error');
                } else {
                    updateRequirementStatus(permissionCheck, 'warning');
                }
                return permission;
            }

            async function updateUI() {
                const isSubscribed = OneSignal.User.PushSubscription.optedIn;
                const permission = OneSignal.Notifications.permissionNative;

                if (isSubscribed) {
                    statusDiv.textContent = 'You are subscribed to notifications.';
                    statusDiv.style.color = 'var(--success-color)';
                    subscribeBtn.textContent = 'Unsubscribe';
                    subscribeBtn.disabled = false;
                } else {
                     if (permission === 'denied') {
                        statusDiv.textContent = 'Notification permission has been denied.';
                        statusDiv.style.color = 'var(--error-color)';
                        subscribeBtn.disabled = true;
                        subscribeBtn.textContent = 'Permission Denied';
                    } else {
                        statusDiv.textContent = 'You are not subscribed.';
                        statusDiv.style.color = 'var(--warning-color)';
                        subscribeBtn.textContent = 'Subscribe';
                        subscribeBtn.disabled = false;
                    }
                }
            }

            async function runChecks() {
                const httpsOk = checkHttps();
                await checkServiceWorker(); // This might take a moment
                const permission = checkNotificationPermission();
                
                if (httpsOk && permission !== 'denied') {
                    subscribeBtn.disabled = false;
                } else {
                    subscribeBtn.disabled = true;
                    if (!httpsOk) {
                         statusDiv.textContent = 'Site must be served over HTTPS.';
                         statusDiv.style.color = 'var(--error-color)';
                    }
                }
                updateUI();
            }

            subscribeBtn.addEventListener('click', async () => {
                const isSubscribed = OneSignal.User.PushSubscription.optedIn;
                if (isSubscribed) {
                    await OneSignal.User.PushSubscription.optOut();
                    console.log('Unsubscribed');
                } else {
                    await OneSignal.User.PushSubscription.optIn();
                    console.log('Subscribed');
                }
                updateUI();
            });

            
            window.OneSignalDeferred.push(async function(OneSignal) {
                OneSignal.Notifications.addEventListener('subscriptionChange', function(isSubscribed) {
                    console.log("The user's subscription state is now:", isSubscribed);
                    updateUI();
                });

                OneSignal.Notifications.addEventListener('permissionChange', function() {
                    updateUI();
                });

                runChecks();
            });
        });
    </script>
</body>
</html>
