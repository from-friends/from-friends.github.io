<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ꜩ Baker Monitor</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, button { margin: 5px 0; padding: 10px; font-size: 16px; }
    #baker-details, #wallet-details, #transaction-details { margin-top: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; background: #f9f9f9; }
    #total-received, #transaction-summary { font-size: 18px; font-weight: bold; color: #333; }
    .baker-link { color: #007BFF; text-decoration: none; font-weight: bold; }
  </style>
</head>
<body>
  <h1>ꜩ Baker Monitor</h1>
  <label for="wallet-address">Tezos Wallet Address:</label>
  <input type="text" id="wallet-address" placeholder="Enter Tezos wallet address...">
  <label for="payout-wallet-address">Baker Payout Wallet Address:</label>
  <input type="text" id="payout-wallet-address" placeholder="If applicable...">
  <button id="fetch-info">Fetch Info</button>
  <div id="transaction-details" style="display: none;">
    <h2>Delegation Rewards</h2>
    <div id="total-received">Total Tezos Received: 0 ꜩ</div>
    <div id="transaction-summary">
      <p>Total Transactions: 0</p>
      <p>First Received Date: -</p>
      <p>Latest Received Date: -</p>
      <p>Next Expected Transaction Date: <span id="next-expected-date">-</span> (<span id="next-expected-human">-</span>)</p>
    </div>
    <ul id="transactions-list"></ul>
    <p><a id="wallet-link" class="baker-link" href="#" target="_blank">View on TzKT</a></p>
  </div>
  <div id="wallet-details" style="display: none;">
    <h2>Wallet Details</h2>
    <p><strong>Address:</strong> <span id="wallet-address-display">-</span></p>
    <p><strong>Current Balance:</strong> <span id="wallet-balance">-</span> ꜩ</p>
  </div>
  <div id="baker-details" style="display: none;">
    <h2>Baker Details</h2>
    <p><strong>Name:</strong> <span id="baker-name">-</span></p>
    <p><strong>Address:</strong> <span id="baker-address">-</span></p>
    <p><a id="baker-link" class="baker-link" href="#" target="_blank">View on TzKT</a></p>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const savedWallet = localStorage.getItem("tezosWalletAddress");
      const savedPayoutWallet = localStorage.getItem("payoutWalletAddress");
      if (savedWallet) document.getElementById("wallet-address").value = savedWallet;
      if (savedPayoutWallet) document.getElementById("payout-wallet-address").value = savedPayoutWallet;
    });

    document.getElementById("fetch-info").addEventListener("click", async () => {
      const wallet = document.getElementById("wallet-address").value.trim();
      const payoutWallet = document.getElementById("payout-wallet-address").value.trim();
      if (!wallet) return alert("Enter a valid Tezos wallet address.");
      localStorage.setItem("tezosWalletAddress", wallet);
      if (payoutWallet) localStorage.setItem("payoutWalletAddress", payoutWallet);

      const walletDetails = document.getElementById("wallet-details");
      const bakerDetails = document.getElementById("baker-details");
      const transactionDetails = document.getElementById("transaction-details");
      walletDetails.style.display = bakerDetails.style.display = transactionDetails.style.display = "none";

      try {
        const walletRes = await fetch(`https://api.tzkt.io/v1/accounts/${wallet}`);
        if (!walletRes.ok) throw new Error(`Failed to fetch wallet details for: ${wallet}`);
        const walletData = await walletRes.json();
        document.getElementById("wallet-address-display").textContent = wallet;
        document.getElementById("wallet-balance").textContent = (walletData.balance / 1e6).toFixed(6);
        walletDetails.style.display = "block";

        if (walletData.delegate) {
          const { alias, address } = walletData.delegate;
          document.getElementById("baker-name").textContent = alias || "N/A";
          document.getElementById("baker-address").textContent = address;
          document.getElementById("baker-link").href = `https://tzkt.io/${address}`;
          document.getElementById("wallet-link").href = `https://tzkt.io/${wallet}`;
          bakerDetails.style.display = "block";
        } else {
          alert("This wallet is not delegated to any baker.");
        }

        const txRes = await fetch(`https://api.tzkt.io/v1/operations/transactions?target=${wallet}&sort.desc=id&limit=2000`);
        if (!txRes.ok) throw new Error("Failed to fetch transactions.");
        const transactions = await txRes.json();
        const filteredTx = payoutWallet ? transactions.filter(tx => tx.sender.address === payoutWallet) : transactions;
        const totalReceived = filteredTx.reduce((sum, tx) => sum + tx.amount, 0) / 1e6;
        const sortedTx = filteredTx.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        const firstDate = sortedTx.length ? new Date(sortedTx[0].timestamp).toLocaleString() : "-";
        const lastDate = sortedTx.length ? new Date(sortedTx[sortedTx.length - 1].timestamp).toLocaleString() : "-";
        let nextDate = "-", nextHuman = "-";
        if (sortedTx.length) {
          const latestDate = new Date(sortedTx[sortedTx.length - 1].timestamp);
          latestDate.setDate(latestDate.getDate() + 3);
          nextDate = latestDate.toLocaleString();
          const diff = Math.floor((latestDate - new Date()) / 1000);
          nextHuman = `in ${Math.floor(diff / 86400)} days and ${Math.floor((diff % 86400) / 3600)} hours`;
        }

        document.getElementById("total-received").textContent = `Total Tezos Received: ${totalReceived.toFixed(6)} ꜩ`;
        document.getElementById("transaction-summary").innerHTML = `
          <p>Total Transactions: ${filteredTx.length}</p>
          <p>First Received Date: ${firstDate}</p>
          <p>Latest Received Date: ${lastDate}</p>
          <p>Next Expected Transaction Date: <span id="next-expected-date">${nextDate}</span> (<span id="next-expected-human">${nextHuman}</span>)</p>`;
        const txList = document.getElementById("transactions-list");
        txList.innerHTML = "";
        filteredTx.forEach(tx => {
          const li = document.createElement("li");
          li.textContent = `Amount: ${tx.amount / 1e6} ꜩ, Date: ${new Date(tx.timestamp).toLocaleString()}`;
          txList.appendChild(li);
        });
        transactionDetails.style.display = "block";
      } catch (error) {
        alert(error.message);
      }
    });
  </script>
</body>
</html>

