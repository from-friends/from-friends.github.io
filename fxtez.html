<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>fx(tez) for fx(hash) - How much is your fxhash.xyz Tezos portfolio worth?</title>

    <script src="qrcode.min.js"></script>
    <script src="html2canvas.min.js"></script>

        <!-- Favicon -->
        <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/svg+xml" href="favicon.svg" />
        <link rel="shortcut icon" href="favicon.ico" />

    <!-- SEO Meta Tags -->
    <meta name="description" content="fx(tez) lets you instantly check stats of your fxhash Tezos collection. Try now for free!">
    <meta name="keywords" content="fxhash, tezos, nft, portfolio, valuation, floor price, crypto, blockchain, art">

    <!-- Open Graph / Facebook Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://from-friends.github.io/fxtez.html">
    <meta property="og:title" content="↗ Your fx(hash) tezos collection stats">
    <meta property="og:description" content="fx(tez) lets you instantly check stats of your fxhash tezos collection. Try now for free!">
    <meta property="og:image" content="social-sharing_fxtez.png"> 

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:domain" content="from-friends.github.io">
    <meta property="twitter:url" content="https://from-friends.github.io/fxtez.html">
    <meta name="twitter:title" content="↗ Your fx(hash) tezos collection stats">
    <meta name="twitter:description" content="fx(tez) lets you instantly check stats of your fxhash tezos collection. Try now for free!">
    <meta name="twitter:image" content="social-sharing_fxtez.png">

    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
            padding-top: 80px; /* Ensuring this matches toolbar height with 40px logo */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .toolbar {
            background-color: #121212;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1100; /* Ensure it's above other fixed elements like loading overlay */
            box-sizing: border-box; /* Include padding in width calculation */
        }

        .toolbar-logo img {
            height: 40px; /* Ensuring logo height is 40px */
            width: auto;
            display: block; /* Removes extra space below image */
        }

        .logo-text {
            font-size: 28px;
            font-weight: bold;
            color: #e0e0e0;
        }

        .donate-button {
            width: 100px; /* Set fixed width */
            padding: 10px 0; /* Adjust padding for fixed width, primarily vertical */
            text-align: center; /* Center text within fixed width */
            border-radius: 8px;
            border: none;
            background-color: #ff0476; /* Same as Check now button */
            color: #121212;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.95em; /* Ensuring font size is as previously accepted */
            text-decoration: none; /* If it were a link */
        }

        .donate-button:not(:disabled):hover {
            background-color: #ff0475f3; /* Consistent hover */
        }

        h1 {
            color: #ff0476;
        }

        .input-section { /* New class for styling the input area */
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 400px; /* Max width for the input section */
            margin-bottom: 20px; /* Space below the input section */
        }

        .input-section h1 {
            color: #ff0476;
            font-size: 1.8em; /* Slightly larger for mobile emphasis */
            text-align: center;
            margin-bottom: 15px;
        }

        input#addressInput {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            border: 1px solid #333;
            background-color: #1e1e1e;
            color: #e0e0e0;
            width: 100%;
            box-sizing: border-box;
            font-size: 1em;
        }

        button {
            padding: 12px 20px; /* Increased padding */
            border-radius: 8px; /* More rounded corners */
            border: none;
            background-color: #ff0476; /* User updated this color */
            color: #121212;
            cursor: pointer;
            font-weight: bold;
            width: 90%; /* Responsive width */
            box-sizing: border-box;
            font-size: 1.1em;
        }

        /* Specific style for fetchButton in .input-section to match addressInput width */
        .input-section button#fetchButton {
            width: 100%;
            margin-bottom: 15px;
        }

        button:disabled {
            background-color: #555;
            color: #aaa;
            cursor: not-allowed;
        }

        #fetchButton.loading-state {
            display: flex;
            align-items: center;
            justify-content: center;
            padding-top: 12px;
            padding-bottom: 12px;
        }

        #fetchButton.loading-state .spinner {
            width: 20px;
            height: 20px;
            border-width: 3px;
            margin: 0 10px 0 0;
        }

        button:not(:disabled):hover {
            background-color: #ff0475f3;
        }

        table {
            width: 90%; /* Adjusted width for more columns */
            margin-top: 20px;
            border-collapse: collapse;
            background-color: #121212;
        }

        th, td {
            border: 1px solid #333;
            padding: 12px;
            text-align: left;
            vertical-align: middle;
        }

        th {
            background-color: #333333;
            color: #ff0476;
        }

        td img {
            max-width: 80px;
            max-height: 80px;
            border-radius: 4px;
            display: block; /* To handle onerror text better */
        }

        /* General link styling within the grouped table */
        #groupedFxhashTable a {
            color: #ff80bf; /* Pink color for all links in this table */
            text-decoration: none;
        }
        #groupedFxhashTable a:hover {
            text-decoration: underline;
        }

        /* Specific link classes can be removed or kept for non-color styles if needed */
        /* .title-link removed as color is handled by general table link style */
        /* .artist-link removed as color is handled by general table link style */
        
        .loading, .error {
            margin-top: 15px;
            font-size: 1.1em;
        }
        .error {
            color: #cf6679;
        }
        .loading {
            color: #03dac6;
        }

        #prominentTotalValueDisplay {
            font-size: 1.6em;
            font-weight: bold;
            color: #ff0476; /* Same as h1 for prominence */
            text-align: center;
            margin-top: 20px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #1e1e1e; /* Optional: slight background to make it a block */
            border-radius: 5px;
            width: 80%; /* Match table width roughly */
            max-width: 600px; /* Max width for very wide screens */
        }

        .action-buttons-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 460px; /* Match widget container width */
        }

        .action-buttons-container button {
            flex: 1; /* Make buttons equal width */
            padding: 10px 20px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            box-sizing: border-box;
            border: 2px solid #ff0476;
            line-height: 1.5; /* Explicitly set line-height for consistency */
        }
        
        #shareButton {
            background-color: #ff0476;
            color: #121212;
        }
        
        #shareButton:hover {
            background-color: #ff0475f3;
        }

        .outline-button {
            background-color: transparent;
            color: #ff0476;
            transition: background-color 0.2s, color 0.2s;
        }

        .outline-button:hover {
            background-color: #ff0476;
            color: #121212;
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; 
            z-index: 1500; /* Sit on top of everything, including toolbar */
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            padding-top: 60px; /* Location of the box */
        }

        .modal-content {
            background-color: #2a2a2a; /* Darker content background */
            margin: 5% auto; 
            padding: 20px;
            border: 1px solid #555;
            width: 80%; 
            max-width: 450px; /* Max width of modal box */
            border-radius: 8px;
            position: relative;
            text-align: center;
        }

        .close-modal-button {
            color: #aaaaaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }

        .close-modal-button:hover,
        .close-modal-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

        #shareCard {
            /* This will be replaced by canvas, styles might be adjusted or removed */
            /* display: none; */ /* Keep for now if text elements are reused alongside canvas */
        }
        #shareCanvasPreview {
            width: 300px; /* Display size for preview in modal */
            height: 300px;
            border: 1px solid #555;
            margin: 20px auto;
            background-color: #333; /* Default bg, will be drawn over */
        }

        #shareCardTitle {
            font-size: 1.5em;
        }
        #shareCardValue {
            font-size: 1.8em; /* Larger for value */
            font-weight: bold;
            margin-bottom: 20px;
            color: #03dac6;
        }
        #shareCardLink {
            font-size: 1em;
            color: #ff80bf; /* Pink for the link text */
        }
        #shareCardLink a {
            color: #ff80bf;
            text-decoration: underline;
        }

        .modal-buttons button {
            padding: 10px 15px;
            margin: 10px 5px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            border: none;
        }
        #modalShareButton {
            background-color: #ff0476;
            color: #121212;
        }
        #modalDownloadButton {
            background-color: #03dac6;
            color: #121212;
        }
    .logo {
        position: absolute;
        top: 20px; /* Adjust as needed for spacing */
        left: 20px; /* Adjust as needed for spacing */
        width: 100px; /* Adjust size as needed */
        height: auto;
    }

    .loading-overlay {
        display: none; /* Hidden by default */
        position: fixed;
        z-index: 2000; /* High z-index to be on top */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(18, 18, 18, 0.85); /* Dark semi-transparent background */
        justify-content: center;
        align-items: center;
        text-align: center;
        color: #e0e0e0;
        font-size: 1.3em; /* Slightly larger font for overlay */
        flex-direction: column; /* To allow for potential spinners or multiple lines later */
    }
    .loading-overlay-content {
        padding: 20px;
        /* Optional: background for the text if needed for contrast or style */
        /* background-color: #1e1e1e; */
        /* border-radius: 8px; */
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3; /* Light grey */
        border-top: 4px solid #ff0476; /* fxhash pink */
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px auto; /* Center spinner and add space below */
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .footer {
        background-color: #121212; /* Consistent with body background */
        color: #e0e0e0; /* Consistent with body text */
        padding: 30px 20px;
        margin-top: 40px;
        border-top: 1px solid #333; /* Subtle separator */
        display: flex;
        flex-direction: column;
        align-items: center;
        font-family: sans-serif;
    }

    .footer-image {
        width: 120px; /* Adjust as needed */
        height: auto;
        margin-bottom: 25px;
    }

    .footer-sections {
        display: flex;
        justify-content: space-around; /* Distribute sections evenly */
        width: 100%;
        max-width: 700px; /* Max width for footer content */
        flex-wrap: wrap; /* Allow sections to wrap on smaller screens */
    }

    .footer-section {
        margin: 15px;
        text-align: left; /* Align text within sections to the left */
        min-width: 200px; /* Minimum width for sections before wrapping */
    }

    .footer-section h3 {
        color: #aaaaaa; /* Changed to grey */
        font-size: 1.2em;
        margin-bottom: 15px;
    }

    .footer-links {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .footer-links li {
        margin-bottom: 8px;
    }

    .footer-links li a {
        color: #aaaaaa; /* Changed to grey */
        text-decoration: none;
        font-size: 0.95em;
    }

    .footer-links li a:hover {
        text-decoration: underline;
    }

        .x-follow-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            background-color: #121212;
            color: white;
            border: none; 
            border-radius: 8px; /* Matched border-radius to check-now button */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            box-shadow: 0 0 0 2px #888888, 0 2px 5px rgba(0, 0, 0, 0.1); /* Grey outline + original shadow */
            margin-top: 15px; /* Added margin to space it from text above */
        }
        
        .x-follow-btn:hover {
            background-color: #222222;
            transform: translateY(-1px);
            box-shadow: 0 0 0 2px #888888, 0 4px 8px rgba(0, 0, 0, 0.15); /* Keep outline on hover */
        }
        
        .x-follow-btn:active {
            transform: translateY(0);
            box-shadow: 0 0 0 2px #888888, 0 2px 3px rgba(0, 0, 0, 0.1); /* Keep outline on active */
        }
        
        .x-follow-btn::before {
            content: "";
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 10px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }

        /* Skeleton Card Styles */
        .widget-container {
            width: 460px;
            max-width: 100%;
        }
        .balance-card {
            background-color: #121212;
            color: #ffffff;
            padding: 25px 20px;
            border-radius: 10px;
            margin-bottom: 5px;
        }
        .balance-card .balance-title {
            font-size: 18px;
            opacity: 0.8;
            margin-bottom: 4px;
        }
        .balance-card .balance-amount {
            font-size: 38px;
            font-weight: 700;
            margin-bottom: 1px;
            letter-spacing: -0.5px;
        }
        .categories-section {
            background-color: #121212;
            border-radius: 5px;
            padding: 5px;
        }
        .category-row {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }
        .category-row:not(:last-child) {
            margin-bottom: 15px;
        }
        .category-box {
            background-color: #121212;
            border: none;
            border-radius: 8px;
            padding: 15px;
            flex: 1;
            min-width: 0;
            text-align: left;
        }
        .category-box .category-amount {
            font-size: 17px;
            font-weight: 700;
            color: #f0f0f0;
            margin-bottom: 4px;
        }
        .category-box .category-label {
            font-size: 11px;
            color: #aaaaaa;
        }
        .separator-line {
            border: none;
            height: 1px;
            background-color: #444444;
            margin: 10px 0;
        }
        @keyframes skeleton-loading {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }
        .skeleton {
            animation: skeleton-loading 1.5s infinite linear;
            background-color: #121212; /* Base color of the skeleton item */
            background-image: linear-gradient(
                90deg,
                #121212,        /* Start color (same as base) */
                #2c2c2c,        /* Shimmer highlight color */
                #121212         /* End color (same as base) */
            );
            background-size: 200px 100%; /* Width of the shimmer effect */
            background-repeat: no-repeat;
            color: transparent !important; /* Ensures no text accidentally shows */
            border-radius: 4px; /* Default rounding for skeleton items */
            display: block; /* Make skeleton elements block by default for easier sizing */
        }

        /* Donate Modal Styles */
        #donateModal {
            align-items: center;
            justify-content: center;
            padding-top: 0;
        }
        #donateModal .modal-content {
            background-color: #121212;
            margin: 0;
            padding: 20px;
            border: 2px solid #444444;
            width: 90%;
            max-width: 380px;
            border-radius: 8px;
            position: relative;
            text-align: center;
        }
        .close-donate-modal-button {
            color: #aaaaaa;
            font-size: 32px;
            font-weight: normal;
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: transparent;
            border: none;
            padding: 10px;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .close-donate-modal-button:hover,
        .close-donate-modal-button:focus {
            color: #fff;
            background-color: rgba(255, 255, 255, 0.15);
            text-decoration: none;
        }
        #donateModal .widget-container { width: 100%; }
        #donateModal .balance-card {
            background-color: #121212;
            color: #ffffff;
            padding: 25px 20px;
            border-radius: 10px;
            margin-bottom: 5px;
        }
        #donateModal .balance-title {
            font-size: 18px;
            opacity: 0.8;
            margin-bottom: 4px;
        }
        #donateModal .actions-container { display: flex; gap: 12px; }
        #donateModal .action-button {
            flex: 1;
            background-color: #ffffff;
            color: #121212;
            border: none;
            padding: 12px 10px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        #donateModal .action-button:hover { background-color: #f0f0f0; }
        #donateModal .profile-card {
            background-color: #121212;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
        }
        #donateModal .profile-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 1px solid #333;
        }
        #donateModal .profile-info-text { text-align: left; flex-grow: 1; }
        #donateModal .profile-username {
            font-size: 15px;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 2px;
        }
        #donateModal .profile-address { font-size: 11px; color: #aaaaaa; }
        #donateModal .qr-code-container {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #121212;
            border-radius: 8px;
            display: inline-block;
        }
        #donateModal #qrcode img {
            display: block;
            margin: auto;
            border: none;
            border-radius: 4px;
        }
        #donateModal .action-button-grey-outline {
            flex: 1;
            background-color: transparent;
            border: 2px solid #555555;
            color: #aaaaaa;
            padding: 12px 10px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }
        #donateModal .action-button-grey-outline:hover,
        #donateModal .action-button-grey-outline:focus {
            background-color: #555555;
            color: #ffffff;
            border-color: #555555;
        }
        #donateModal .footer-content { text-align: center; margin-bottom: 20px; }
        #donateModal .footer-content p {
            font-size: 14px;
            color: #aaaaaa;
            margin-top: 0;
            margin-bottom: 0;
        }

        .demo-link {
            font-size: 0.9em;
            color: #aaaaaa;
            text-decoration: underline;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
        }
        .demo-link:hover {
            color: #e0e0e0;
        }
    </style>

<script defer src="https://cloud.umami.is/script.js" data-website-id="77f26836-27dd-4d25-b9b0-dcf4cdf4b2b7"></script>  
</head>
<body>
    <header class="toolbar">
        <a href="https://from-friends.github.io/fxhash.html" rel="noopener noreferrer" class="toolbar-logo" style="text-decoration: none;">
            <span class="logo-text">fx(tez)</span>
        </a>
        <button class="donate-button">Donate</button>
    </header>

    <a href="https://from-friends.github.io/" target="_blank" rel="noopener noreferrer" class="logo">
        <img src="fromfriends.svg" alt="fromfriends logo" style="display: block; width: 100%; height: auto;">
    </a>

    <div id="loadingOverlayModal" class="loading-overlay">
        <div class="spinner"></div>
        <div id="loadingOverlayText" class="loading-overlay-content">Loading...</div>
        <p style="margin-top: 10px; margin-bottom: 0px; font-size: 0.9em;">Follow us on X while the data loads:</p>
        <a href="https://x.com/FromFriends__" class="x-follow-btn" target="_blank" rel="noopener noreferrer">Follow us on X @FromFriends__</a>
    </div>

    <div class="input-section"> <!-- Wrap heading, input, and button -->
        <h1>How much is your fx(hash) tezos collection worth?</h1>
        <input type="text" id="addressInput" placeholder="Enter Tezos address (tz... or .tez)" value="">
        <button id="fetchButton">Check now</button>
        <a href="#" id="demoLink" class="demo-link">Try a demo</a>
    </div>

    <div id="skeletonLoader" style="display: none; margin-top: 10px;">
        <div class="widget-container">
         
            <div class="balance-card">
                <!-- — Your collection stats -->
                <div class="balance-title"><strong>fx(tez)</strong> ×  </div>
                <div class="balance-amount" id="resultsTotalValue"><div class="skeleton" style="width: 200px; height: 38px; border-radius: 4px;"></div></div>
              
                <div class="category-label">Total Floor Value</div>


            </div>
            <div class="categories-section">
                <div class="category-row">
                    <div class="category-box">
                        <div class="category-amount" id="resultsCollectedIterations"><div class="skeleton" style="width: 60px; height: 17px; border-radius: 3px;"></div></div>
                        <div class="category-label">Collected Iterations</div>
                    </div>
                    <div class="category-box">
                        <div class="category-amount" id="resultsTopArtist"><div class="skeleton" style="width: 120px; height: 17px; border-radius: 3px;"></div></div>
                        <div class="category-label">#1 Artist</div>
                    </div>
                </div>
                <div class="category-row">
                    <div class="category-box">
                        <div class="category-amount" id="resultsUniqueArtists"><div class="skeleton" style="width: 50px; height: 17px; border-radius: 3px;"></div></div>
                        <div class="category-label">Unique Artists</div>
                    </div>
                    <div class="category-box">
                        <div class="category-amount" id="resultsMostValuable"><div class="skeleton" style="width: 100px; height: 17px; border-radius: 3px;"></div></div>
                        <div class="category-label">Most Valuable Iteration</div>
                    </div>
                </div>
            </div>
          
        </div>

        <div id="prominentTotalValueDisplay" style="display:none;"></div>
        <div class="action-buttons-container">
            <button id="shareButton" style="display:none;">Share on 𝕏</button>
            <button id="downloadStatsButton" class="outline-button" style="display:none;">Download as Image</button>
        </div>
        
    </div>

    <div style="margin-top: 15px; margin-bottom: 10px; display:none;">
        <input type="checkbox" id="toggleThumbnailsCheckbox" checked>
        <label for="toggleThumbnailsCheckbox">Hide Thumbnails</label>
    </div>

    <div id="statusMessage" class="loading" style="display:none;">Loading...</div>
    <div id="errorMessage" class="error" style="display:none;"></div>

    <!-- artworksTable is hidden and not primary, can be removed if not needed for other purposes -->
    <table id="artworksTable" style="display:none;">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Contract</th>
                <th>Image</th>
                <th>ID</th>
            </tr>
        </thead>
        <tbody id="artworksTableBody">
        </tbody>
    </table>

    <div id="groupedFxhashStatusMessage" class="loading" style="display:none; margin-top: 20px;"></div>
    <div id="fxhashTokenCountDisplay" style="margin-top: 10px; margin-bottom: 5px; font-weight: bold; text-align: center;"></div>
    <table id="groupedFxhashTable" style="display:none; margin-top: 20px;">
        <thead>
            <tr>
                <th>ID</th>
                <th>Floor Price</th>
                <th>Artist</th>
                <th>Thumbnail</th>
                <th>Title</th>
                <th>Token</th>
                <th>Contract</th>
            </tr>
        </thead>
        <tbody id="groupedFxhashTableBody">
            <!-- Grouped fxhash tokens will be inserted here -->
        </tbody>
        <tfoot id="groupedFxhashTableFooter">
            <!-- Total gallery floor value will be inserted here -->
        </tfoot>
    </table>

    <div id="endOfPageDonateSection" style="display:none; margin-top: 40px; text-align: center;">
        <p style="color: #aaaaaa; margin-bottom: 15px; font-size: 1.1em;">Enjoying this tool? Show your support.</p>
        <button class="donate-button" style="width: 150px; padding: 12px 20px;">Donate</button>
    </div>

    <!-- Share Modal Structure -->
    <div id="sharePreviewModal" class="modal">
        <div class="modal-content">
            <span class="close-modal-button">&times;</span>
            <h2>Share Your Valuation</h2>
            <!-- <div id="shareCard"> -->
                <!-- <div id="shareCardTitle">My fx(hash) portfolio valuation</div> -->
                <!-- <div id="shareCardValue">0 XTZ</div> -->
                <!-- <div id="shareCardLink">via <a href="https://floorcheck.com" target="_blank">floorcheck.com</a></div> -->
            <!-- </div> -->
            <canvas id="shareCanvasPreview"></canvas> <!-- Canvas replaces shareCard div -->

            <p style="font-size: 0.9em; color: #aaa;">Note: This is a visual preview. Sharing will attempt to use the image; downloading provides the image.</p>
            <div class="modal-buttons">
                <button id="modalShareButton">Share Image</button>
                <button id="modalDownloadButton">Download Image</button>
            </div>
        </div>
    </div>

    <!-- Donate Modal -->
    <div id="donateModal" class="modal">
        <div class="modal-content">
            <span class="close-donate-modal-button">&times;</span>
            <div class="widget-container">
                <div class="balance-title" style="text-align: center; margin-bottom: 15px;"><strong>DONATE</strong></div>
                <div class="footer-content">
                    <p>Many thanks for your support! 🫶</p>
                </div>
                <div class="profile-card" style="margin-top: 15px;">
                    <img src="avatar-placeholder.jpg" alt="Donation Avatar" class="profile-avatar">
                    <div class="profile-info-text">
                        <div class="profile-username">fromfriends.tez</div>
                        <div class="profile-address" id="tezosAddressValue">tz1U49JkLGSUR7JFN5xFoFghNwMXnQtR7Pv5</div>
                    </div>
                </div>
                <div class="balance-card">
                    <div class="actions-container" style="margin-top:-20px; display: flex; gap: 10px;">
                        <button type="button" id="copyAddressBtn" class="action-button">Copy Address</button>
                        <a href="https://kukai.app" target="_blank" rel="noopener noreferrer" class="action-button-grey-outline">Open Kukai Wallet</a>
                    </div>
                    <div style="text-align: center; margin-top: 40px;">
                        <p style="font-size: 0.9em; color: #aaaaaa; margin-bottom: 8px;">Scan the FromFriends Tezos address</p>
                        <div class="qr-code-container" style="margin-top:0; margin-bottom: 10px;">
                            <div id="qrcode"></div>
                        </div>
                    </div>
                </div>
                <hr class="separator-line">
            </div>
        </div>
    </div>


    <script>
        // Global state
        let ownedLoading = false;
        let ownedError = null;
        let ownedItems = []; 
        let showThumbnails = true; // Default to true to show thumbnails initially

        const addressInput = document.getElementById('addressInput');
        const demoLink = document.getElementById('demoLink');
        const fetchButton = document.getElementById('fetchButton');
        const artworksTable = document.getElementById('artworksTable'); // Kept for potential future use or complete removal
        const artworksTableBody = document.getElementById('artworksTableBody'); // Kept for potential future use
        const statusMessage = document.getElementById('statusMessage');
        const errorMessage = document.getElementById('errorMessage');
        const toggleThumbnailsCheckbox = document.getElementById('toggleThumbnailsCheckbox'); // Still get it, but won't add listener
        const shareButton = document.getElementById('shareButton');

        // Loading Overlay Modal elements
        const loadingOverlayModal = document.getElementById('loadingOverlayModal');
        const loadingOverlayText = document.getElementById('loadingOverlayText');

        // Donate Modal elements
        const donateButtons = document.querySelectorAll('.donate-button');
        const donateModal = document.getElementById('donateModal');
        const closeDonateModalButton = document.querySelector('.close-donate-modal-button');
        let qrCodeGenerated = false;

        // Modal elements
        const sharePreviewModal = document.getElementById('sharePreviewModal');
        const closeModalButton = document.querySelector('.close-modal-button');
        const shareCanvasPreview = document.getElementById('shareCanvasPreview'); // Get canvas element
        const modalShareButton = document.getElementById('modalShareButton');
        const modalDownloadButton = document.getElementById('modalDownloadButton');
        const downloadStatsButton = document.getElementById('downloadStatsButton');

        // Function to resolve .tez domains (adapted from tezos_domain_resolver.html)
        async function resolveTezosDomain(domain) {
            const cleanDomainInput = domain.trim();
            const cleanDomainLower = cleanDomainInput.toLowerCase();
            
            statusMessage.textContent = `Resolving ${cleanDomainInput}...`;
            statusMessage.style.display = 'block';
            errorMessage.style.display = 'none';

            if (!cleanDomainLower.endsWith('.tez')) {
                // Should not happen if called correctly, but as a safeguard
                return { success: true, address: cleanDomainInput, message: 'Input is a direct address.' };
            }

            try {
                const query = {
                    query: `{
                        domain(name: "${cleanDomainLower}") {
                            name
                            address
                        }
                    }`
                };

                const response = await fetch('https://api.tezos.domains/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(query)
                });

                if (response.ok) {
                    const responseData = await response.json();
                    console.log('Tezos Domains API response for', cleanDomainLower, ':', responseData);
                    
                    if (responseData.data && responseData.data.domain && responseData.data.domain.address) {
                        return { success: true, address: responseData.data.domain.address, domainName: responseData.data.domain.name };
                    } else if (responseData.data && responseData.data.domain === null) {
                        return { success: false, error: `Domain \'${cleanDomainInput}\' not found or has no address.` };
                    } else if (responseData.errors) {
                         return { success: false, error: `API Error: ${responseData.errors.map(e => e.message).join(', ')}` };
                    }
                    else {
                        return { success: false, error: 'Could not resolve domain. Unexpected API response.' };
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Tezos Domains API request failed:', response.status, errorText);
                    return { success: false, error: `API request failed with status ${response.status}.` };
                }
            } catch (error) {
                console.error('Error during domain resolution:', error);
                return { success: false, error: `An unexpected error occurred during resolution: ${error.message}` };
            }
        }

        // toggleThumbnailsCheckbox.checked = showThumbnails; // Removed, checkbox is hidden

        function formatIpfsUrl(uri) {
            if (uri && uri.startsWith('ipfs://')) {
                return `https://ipfs.io/ipfs/${uri.substring(7)}`;
            }
            return uri;
        }

        function formatArtist(creator) {
            if (!creator || !creator.holder) return 'Unknown';
            if (creator.holder.alias) return creator.holder.alias;
            if (creator.holder.address) {
                const address = creator.holder.address;
                return `${address.slice(0, 6)}...${address.slice(-4)}`;
            }
            return 'Unknown';
        }

        function truncateAddress(address, startLength = 5, endLength = 5) {
            if (!address || address.length <= startLength + endLength + 3) {
                return address;
            }
            const start = address.substring(0, startLength);
            const end = address.substring(address.length - endLength);
            return `${start}...${end}`;
        }

        async function getDisplayNameForAddress(address) {
            // Check for alias from TzKT
            try {
                const tzktRes = await fetch(`https://api.tzkt.io/v1/accounts/${address}`);
                if (tzktRes.ok) {
                    const accountData = await tzktRes.json();
                    if (accountData.alias) {
                        return accountData.alias;
                    }
                }
            } catch (e) {
                console.error(`Error fetching account alias from TzKT for ${address}`, e);
            }

            // Check for .tez domain from Tezos Domains
            try {
                const query = { query: `{ reverseRecord(address: "${address}") { domain { name } } }`};
                const domainRes = await fetch('https://api.tezos.domains/graphql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(query)
                });
                if (domainRes.ok) {
                    const domainData = await domainRes.json();
                    if (domainData.data?.reverseRecord?.domain?.name) {
                        return domainData.data.reverseRecord.domain.name;
                    }
                }
            } catch (e) {
                console.error(`Error fetching reverse record from Tezos Domains for ${address}`, e);
            }

            // Fallback: check for .tez domain from TzKT
            try {
                const tzktDomainRes = await fetch(`https://api.tzkt.io/v1/domains/${address}/reverse`);
                if (tzktDomainRes.ok) {
                    const tzktDomainText = await tzktDomainRes.text();
                    if (tzktDomainText) {
                        const domain = JSON.parse(tzktDomainText).name;
                        if(domain) return domain;
                    }
                }
            } catch (e) {
                    console.error(`TzKT reverse lookup for ${address} failed`, e);
            }

            return null; // Return null if no alias or domain found
        }

        function drawShareImageOnCanvas(canvas, valueString) {
            const ctx = canvas.getContext('2d');
            const width = 1080; // Actual draw width
            const height = 1080; // Actual draw height
            canvas.width = width; // Set canvas internal resolution
            canvas.height = height;

            // Background
            ctx.fillStyle = '#333333'; // Dark background
            ctx.fillRect(0, 0, width, height);

            // Title
            ctx.fillStyle = '#ff0476'; // Purple
            ctx.font = 'bold 72px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('My fx(hash) portfolio valuation', width / 2, height * 0.3);

            // Value
            ctx.fillStyle = '#03dac6'; // Teal
            ctx.font = 'bold 120px sans-serif';
            ctx.fillText(valueString, width / 2, height * 0.55);

            // Link Text
            ctx.fillStyle = '#ff80bf'; // Pink
            ctx.font = 'italic 50px sans-serif';
            ctx.fillText('via floorcheck.com', width / 2, height * 0.75);
        }

        async function fetchOwned(address) {
          ownedLoading = true;
          ownedError = null;
          ownedItems = []; 
          document.getElementById('skeletonLoader').style.display = 'block';

          errorMessage.style.display = 'none';
          artworksTable.style.display = 'none'; 
          document.getElementById('groupedFxhashTable').style.display = 'none'; 
          document.getElementById('groupedFxhashStatusMessage').style.display = 'none';
          document.getElementById('groupedFxhashTableBody').innerHTML = ''; 
          document.getElementById('groupedFxhashTableFooter').innerHTML = '';

          const BATCH_SIZE = 50;
          let currentOffset = 0;
          let hasMore = true;

          while (hasMore) {
            const query = `
              query GetUserOwnedTokens($address: String!, $limit: Int!, $offset: Int!) {
                token(
                  where: {
                    holders: {holder_address: {_eq: $address}},
                    supply: {_gt: "0"} 
                  },
                  order_by: {pk: desc},
                  limit: $limit,
                  offset: $offset
                ) {
                  pk
                  name
                  display_uri
                  artifact_uri
                  token_id
                  fa {
                    name
                    contract
                  }
                  galleries(limit: 1) { 
                    gallery {
                      gallery_id 
                      name
                      floor_price 
                    }
                  }
                  creators(limit: 1) {
                    holder {
                      address
                      alias
                    }
                  }
                }
              }`;

            try {
              const response = await fetch('https://data.objkt.com/v3/graphql', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  query: query,
                  variables: { 
                    address: address,
                    limit: BATCH_SIZE,
                    offset: currentOffset
                  }
                }),
              });

              const result = await response.json();
              console.log(`Owned Tokens API Response (Offset: ${currentOffset}):`, result);

              if (result.errors) {
                throw new Error(result.errors.map(e => e.message).join(', '));
              }

              const newTokensData = result.data.token;

              if (newTokensData && newTokensData.length > 0) {
                const mappedTokensPromises = newTokensData.map(async token => {
                  let imageUrl = token.display_uri || token.artifact_uri;
                  imageUrl = formatIpfsUrl(imageUrl);
                  
                  let galleryIdForFetch = null;
                  let galleryFloor = null; 
                  const contractName = token.fa && token.fa.name ? token.fa.name : '';
                  const creatorInfo = token.creators && token.creators.length > 0 ? token.creators[0] : null;
                  const artistDisplay = formatArtist(creatorInfo);
                  const artistObjktAddress = creatorInfo && creatorInfo.holder ? creatorInfo.holder.address : null;
                  const faContract = token.fa && token.fa.contract ? token.fa.contract : null;
                  const tokenId = token.token_id ? token.token_id : null;

                  if (token.galleries && token.galleries.length > 0 && token.galleries[0].gallery) {
                    const galleryInfo = token.galleries[0].gallery;
                    if (galleryInfo.gallery_id) {
                         galleryIdForFetch = galleryInfo.gallery_id;
                    }
                    if (galleryInfo.floor_price !== undefined && galleryInfo.floor_price !== null) {
                        galleryFloor = Number(galleryInfo.floor_price);
                    }
                  }

                  return {
                    id: token.pk,
                    title: token.name || 'Untitled Token',
                    contractName: contractName || 'N/A',
                    image: imageUrl || 'placeholder_small_dark.jpg',
                    galleryId: galleryIdForFetch ? String(galleryIdForFetch) : 'N/A',
                    galleryFloorPrice: galleryFloor,
                    artistDisplay: artistDisplay,
                    artistObjktAddress: artistObjktAddress,
                    faContract: faContract,
                    tokenId: tokenId
                  };
                });
                
                const newMappedItems = await Promise.all(mappedTokensPromises);
                ownedItems.push(...newMappedItems);
                fetchButton.innerHTML = `<div class="spinner"></div>Fetched ${ownedItems.length} tokens...`;

                if (newTokensData.length < BATCH_SIZE) {
                  hasMore = false; 
                } else {
                  currentOffset += BATCH_SIZE;
                  await new Promise(resolve => setTimeout(resolve, 200)); 
                }
              } else {
                hasMore = false; 
                if (ownedItems.length === 0) {
                     statusMessage.textContent = 'No owned tokens found for this user.';
                }
              }
            } catch (error) {
              ownedError = `Error during fetch (Offset: ${currentOffset}): ${error.message}`;
              hasMore = false; 
              errorMessage.textContent = ownedError;
              errorMessage.style.display = 'block';
              console.error('Error fetching owned tokens:', error);
            } finally { // Added finally block to ensure modal is hidden
                if (!hasMore) { // Only hide if loop is actually finished or error occurred
                   // document.getElementById('skeletonLoader').style.display = 'none';
                }
            }
          } 

          // This final hide might be redundant if finally block works as expected, but good as a fallback
          // Ensure modal is hidden if loop finishes cleanly without entering finally for the last batch
          if (!ownedLoading || !hasMore) { // Check if loading is complete or no more items
          //  document.getElementById('skeletonLoader').style.display = 'none';
          }

          ownedLoading = false;
          if (!ownedError) {
            if (ownedItems.length > 0) {
                statusMessage.style.display = 'none'; // Hide general status if we have items and table will show
            } else {
                // If no items after fetch, statusMessage already set by the loop or initial check
                statusMessage.style.display = 'block'; 
            }
            const groupedFxhash = groupFxhashTokensByGallery(ownedItems);
            renderGroupedFxhashTable(groupedFxhash);
            artworksTable.style.display = 'none'; // Ensure old table remains hidden

            // logPortfolioInsights(ownedItems); // Call to log insights

          } else {
             document.getElementById('skeletonLoader').style.display = 'none';
             artworksTable.style.display = 'none';
             document.getElementById('groupedFxhashTable').style.display = 'none';
          }
        }

        function groupFxhashTokensByGallery(items) {
            const grouped = {};
            items.forEach(item => {
                const isFxhash = item.contractName && 
                                 (item.contractName.toLowerCase().includes('fx(hash)') || 
                                  item.contractName.toLowerCase().includes('fxhash'));
                if (isFxhash && item.galleryId && item.galleryId !== 'N/A') {
                    if (!grouped[item.galleryId]) {
                        grouped[item.galleryId] = [];
                    }
                    grouped[item.galleryId].push(item);
                }
            });
            console.log("Grouped fx(hash) tokens:", grouped);
            return grouped;
        }

        function renderGroupedFxhashTable(groupedTokens) {
            const tableBody = document.getElementById('groupedFxhashTableBody');
            const tableElement = document.getElementById('groupedFxhashTable');
            const statusMsgEl = document.getElementById('groupedFxhashStatusMessage');
            const tableFooter = document.getElementById('groupedFxhashTableFooter');
            // const fxhashTokenCountDisplayEl = document.getElementById('fxhashTokenCountDisplay'); // Line commented out/removed
            let shareButtonEl = document.getElementById('shareButton');
            let downloadStatsButtonEl = document.getElementById('downloadStatsButton');
            tableBody.innerHTML = ''; 
            tableFooter.innerHTML = ''; 
            // fxhashTokenCountDisplayEl.innerHTML = ''; // Line commented out/removed
            shareButtonEl.style.display = 'none'; 
            downloadStatsButtonEl.style.display = 'none';

            if (Object.keys(groupedTokens).length === 0) {
                tableElement.style.display = 'none';
                statusMsgEl.textContent = 'No fx(hash) tokens with gallery IDs found to display.';
                statusMsgEl.style.display = 'block';
                // fxhashTokenCountDisplayEl.style.display = 'none'; // Line commented out/removed
                return;
            }

            tableElement.style.display = 'table';
            statusMsgEl.style.display = 'none';
            // fxhashTokenCountDisplayEl.style.display = 'block'; // Line commented out/removed

            let totalGalleryFloorValueMutez = 0;
            let totalFxhashTokenInTableCount = 0;

            console.log("--- Calculating Total Token Floor Value (Gallery Floor x Token Count) ---");

            for (const galleryId in groupedTokens) {
                const tokensInGallery = groupedTokens[galleryId];
                totalFxhashTokenInTableCount += tokensInGallery.length;
                const firstTokenInGroup = tokensInGallery[0];

                if (firstTokenInGroup.galleryFloorPrice !== null && 
                    firstTokenInGroup.galleryFloorPrice !== undefined) {
                    
                    const galleryFloor = firstTokenInGroup.galleryFloorPrice;
                    const tokenCount = tokensInGallery.length;
                    const galleryContribution = galleryFloor * tokenCount;
                    totalGalleryFloorValueMutez += galleryContribution;

                    console.log(`Gallery ID: ${galleryId}, Floor: ${galleryFloor / 1000000} XTZ, Token Count: ${tokenCount}, Contributing to Total: ${galleryContribution / 1000000} XTZ`);
                }

                tokensInGallery.forEach((token, index) => {
                    const row = tableBody.insertRow();
                    if (index === 0) {
                        const galleryIdCell = row.insertCell();
                        galleryIdCell.rowSpan = tokensInGallery.length;
                        galleryIdCell.style.verticalAlign = 'top';
                        galleryIdCell.style.width = '8%'; // Make Gallery ID column less wide

                        const galleryLink = document.createElement('a');
                        galleryLink.href = `https://objkt.com/collections/fxhash/projects/${galleryId}?ref=tz1U49JkLGSUR7JFN5xFoFghNwMXnQtR7Pv5`;
                        galleryLink.textContent = galleryId;
                        galleryLink.target = '_blank';
                        galleryLink.rel = 'noopener noreferrer';
                        galleryIdCell.appendChild(galleryLink);

                        const galleryFloorCell = row.insertCell();
                        galleryFloorCell.rowSpan = tokensInGallery.length;
                        galleryFloorCell.style.verticalAlign = 'top';
                        galleryFloorCell.style.width = '15%'; // Make Floor Price column a bit wider
                        if (firstTokenInGroup.galleryFloorPrice !== null && firstTokenInGroup.galleryFloorPrice !== undefined) {
                            galleryFloorCell.innerHTML = `<strong>${firstTokenInGroup.galleryFloorPrice / 1000000}</strong> ꜩ`;
                        } else {
                            galleryFloorCell.textContent = 'N/A';
                        }
                    }

                    const artistCell = row.insertCell();
                    if (token.artistObjktAddress) {
                        const artistLink = document.createElement('a');
                        artistLink.href = `https://objkt.com/profile/${token.artistObjktAddress}?ref=tz1U49JkLGSUR7JFN5xFoFghNwMXnQtR7Pv5`;
                        artistLink.textContent = token.artistDisplay;
                        artistLink.target = '_blank';
                        artistLink.rel = 'noopener noreferrer';
                        artistCell.appendChild(artistLink);
                    } else {
                        artistCell.textContent = token.artistDisplay;
                    }
                    artistCell.style.verticalAlign = 'top'; 
                    if(index !== 0) { 
                        // This ensures correct column alignment if artist name is very long
                    }


                    const thumbnailCell = row.insertCell();
                    if (showThumbnails) {
                        const img = document.createElement('img');
                        img.src = token.image;
                        img.alt = token.title;
                        img.onerror = function() { 
                            this.style.display = 'none'; // Hide broken image icon
                            const noImageText = document.createElement('span');
                            noImageText.textContent = 'No Image';
                            this.parentElement.appendChild(noImageText);
                        };

                        if (token.faContract && token.tokenId) {
                            const thumbLink = document.createElement('a');
                            thumbLink.href = `https://objkt.com/tokens/${token.faContract}/${token.tokenId}?ref=tz1U49JkLGSUR7JFN5xFoFghNwMXnQtR7Pv5`;
                            thumbLink.target = '_blank';
                            thumbLink.rel = 'noopener noreferrer';
                            thumbLink.appendChild(img);
                            thumbnailCell.appendChild(thumbLink);
                        } else {
                            thumbnailCell.appendChild(img);
                        }
                    } else {
                        thumbnailCell.textContent = '(hidden)';
                    }
                    
                    const titleCell = row.insertCell();
                    if (token.faContract && token.tokenId) {
                        const objktLink = document.createElement('a');
                        objktLink.href = `https://objkt.com/tokens/${token.faContract}/${token.tokenId}?ref=tz1U49JkLGSUR7JFN5xFoFghNwMXnQtR7Pv5`;
                        objktLink.textContent = token.title || 'Untitled';
                        objktLink.target = '_blank';
                        objktLink.rel = 'noopener noreferrer';
                        titleCell.appendChild(objktLink);
                    } else {
                        titleCell.textContent = token.title || 'Untitled'; // Fallback if no link data
                    }

                    const pkCell = row.insertCell();
                    pkCell.textContent = token.id; 

                    const contractCell = row.insertCell();
                    contractCell.textContent = token.contractName || 'N/A';
                });
            }

            console.log("---------------------------------------------------------------------");
            
            // Update Prominent Total Value Display
            const totalXTZ = totalGalleryFloorValueMutez / 1000000;
            renderPortfolioInsights(ownedItems, totalXTZ);

            if (totalGalleryFloorValueMutez > 0 || totalFxhashTokenInTableCount > 0) { 
                // Setup Main Share Button to open Modal
                shareButtonEl.style.display = 'block';
                downloadStatsButtonEl.style.display = 'block';
                const newMainShareButton = shareButtonEl.cloneNode(true);
                shareButtonEl.parentNode.replaceChild(newMainShareButton, shareButtonEl);
                shareButtonEl = newMainShareButton; // Update reference to the new button

                shareButtonEl.addEventListener('click', () => {
                    // const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent('@FromFriends__')}&url=https://from-friends.github.io/fxhash.html`;
                   
                    const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent('Check your fx(hash) tezos collection stats!')}&url=https://from-friends.github.io/fxtez.html&via=FromFriends__&related=FromFriends__`;
                    window.open(shareUrl, '_blank');
                });

            } else {
                shareButtonEl.style.display = 'none'; // Hide share button if no value/tokens
                downloadStatsButtonEl.style.display = 'none';
            }

            if (Object.keys(groupedTokens).length > 0) {
                const footerRow = tableFooter.insertRow();
                const labelCell = footerRow.insertCell();
                labelCell.colSpan = 2; 
                labelCell.textContent = 'Total Value:';
                labelCell.style.textAlign = 'right';
                labelCell.style.fontWeight = 'bold';

                const totalFloorCell = footerRow.insertCell();
                totalFloorCell.innerHTML = `<strong>${(totalGalleryFloorValueMutez / 1000000).toLocaleString()}</strong> ꜩ`;
                totalFloorCell.style.fontWeight = 'bold'; // This bold is for the number, XTZ will be regular due to HTML structure
                totalFloorCell.colSpan = 5; // Adjusted to span Artist, Thumbnail, Title, PK, Contract Name

                document.getElementById('endOfPageDonateSection').style.display = 'block';
            }
        }

        // renderTable function (for artworksTable) - kept for now but not primary
        function renderTable() { 
            artworksTableBody.innerHTML = ''; 
            let itemsToRender = ownedItems; 
            if (itemsToRender.length === 0) {
                // artworksTable.style.display = 'none'; // Already handled
                if (!ownedError && !ownedLoading) { 
                    // statusMessage.textContent = 'No artworks to display in the general table.'; // Not primary
                    // statusMessage.style.display = 'block';
                }
                return;
            }
            // artworksTable.style.display = 'table'; // Not primary

            itemsToRender.forEach(item => {
                const row = artworksTableBody.insertRow();
                row.insertCell().textContent = item.id;
                row.insertCell().textContent = item.title;
                row.insertCell().textContent = item.contractName;
                const imageCell = row.insertCell();
                if (showThumbnails) {
                    const img = document.createElement('img');
                    img.src = item.image;
                    img.alt = item.title;
                    imageCell.appendChild(img);
                }
                row.insertCell().textContent = item.galleryId;
            });
        }

        fetchButton.addEventListener('click', async () => {
            fetchButton.disabled = true;
            fetchButton.classList.add('loading-state');
            fetchButton.innerHTML = `<div class="spinner"></div>Fetching tokens...`;

            try {
                const userInput = addressInput.value.trim();
                if (!userInput) {
                    errorMessage.textContent = 'Please enter a Tezos address or .tez domain.';
                    errorMessage.style.display = 'block';
                    statusMessage.style.display = 'none';
                    artworksTable.style.display = 'none';
                    document.getElementById('groupedFxhashTable').style.display = 'none';
                    return;
                }

                localStorage.setItem('lastFxhashAddress', userInput);
                const url = new URL(window.location);
                url.searchParams.set('address', userInput);
                window.history.pushState({}, '', url);

                resetResultsCard();
                document.getElementById('endOfPageDonateSection').style.display = 'none';
                document.getElementById('groupedFxhashTableBody').innerHTML = '';
                document.getElementById('groupedFxhashTableFooter').innerHTML = '';
                document.getElementById('groupedFxhashTable').style.display = 'none';
                document.getElementById('groupedFxhashStatusMessage').style.display = 'none';
                errorMessage.style.display = 'none';
                statusMessage.textContent = 'Starting...';
                statusMessage.style.display = 'block';

                const balanceTitle = document.querySelector('.balance-title');
                balanceTitle.innerHTML = `<strong>fx(tez)</strong> × <span id="displayNameSpan"></span>`;
                const displayNameSpan = document.getElementById('displayNameSpan');

                let addressToFetch = userInput;
                let domainNameFromInput = null;

                if (userInput.toLowerCase().endsWith('.tez')) {
                    const resolutionResult = await resolveTezosDomain(userInput);
                    if (resolutionResult.success && resolutionResult.address) {
                        addressToFetch = resolutionResult.address;
                        domainNameFromInput = resolutionResult.domainName || userInput;
                        displayNameSpan.textContent = domainNameFromInput;
                    } else {
                        errorMessage.textContent = `Failed to resolve domain: ${resolutionResult.error || 'Unknown error'}`;
                        errorMessage.style.display = 'block';
                        statusMessage.style.display = 'none';
                        return;
                    }
                } else {
                    displayNameSpan.textContent = truncateAddress(addressToFetch);
                    statusMessage.textContent = '';
                    statusMessage.style.display = 'block';
                }

                // Asynchronously update with alias or reverse domain if available
                getDisplayNameForAddress(addressToFetch).then(name => {
                    if (name) {
                        displayNameSpan.textContent = name;
                    }
                });

                ownedItems = [];
                ownedLoading = false;
                ownedError = null;
                document.getElementById('shareButton').style.display = 'none';
                document.getElementById('downloadStatsButton').style.display = 'none';
                
                await fetchOwned(addressToFetch);
            } finally {
                fetchButton.disabled = false;
                fetchButton.classList.remove('loading-state');
                fetchButton.innerHTML = 'Check now';
            }
        });

        addressInput.addEventListener('input', () => {
            if (addressInput.value.trim() === '') {
                // Clear URL parameter
                const url = new URL(window.location);
                url.searchParams.delete('address');
                window.history.pushState({}, '', url);

                // Clear localStorage
                localStorage.removeItem('lastFxhashAddress');
            }
        });

        // toggleThumbnailsCheckbox.addEventListener('change', () => { // Removed event listener
        //     showThumbnails = toggleThumbnailsCheckbox.checked;
        //     const groupedFxhashTableBody = document.getElementById('groupedFxhashTableBody');
        //     if (groupedFxhashTableBody.innerHTML.trim() !== '') {
        //          const grouped = groupFxhashTokensByGallery(ownedItems); 
        //          renderGroupedFxhashTable(grouped);
        //     }
        //     // renderTable(); // If artworksTable was primary
        // });

        // Optional: Automatically fetch for a default address on page load
        // if (addressInput.value) {
        //     fetchOwned(addressInput.value);
        // }

        // Modal Event Listeners
        if (closeModalButton) {
            closeModalButton.onclick = function() {
                sharePreviewModal.style.display = "none";
            }
        }
        // Close modal if user clicks outside of the modal-content
        window.onclick = function(event) {
            if (event.target == sharePreviewModal) {
                sharePreviewModal.style.display = "none";
            }
            if (event.target == donateModal) {
                donateModal.style.display = "none";
            }
        }

        if (donateButtons.length > 0) {
            donateButtons.forEach(button => {
                button.addEventListener('click', () => {
                    donateModal.style.display = 'flex';
                    if (!qrCodeGenerated) {
                        const tezosAddress = "tz1U49JkLGSUR7JFN5xFoFghNwMXnQtR7Pv5";
                        new QRCode(document.getElementById("qrcode"), {
                            text: tezosAddress,
                            width: 180,
                            height: 180,
                            colorDark : "#e0e0e0",
                            colorLight : "#121212",
                            correctLevel : QRCode.CorrectLevel.H
                        });
                        qrCodeGenerated = true;
                    }
                });
            });
        }

        if (closeDonateModalButton) {
            closeDonateModalButton.addEventListener('click', function() {
                donateModal.style.display = "none";
            });
        }

        const copyBtn = document.getElementById('copyAddressBtn');
        if (copyBtn) {
            copyBtn.addEventListener('click', function() {
                const tezosAddress = "tz1U49JkLGSUR7JFN5xFoFghNwMXnQtR7Pv5";
                navigator.clipboard.writeText(tezosAddress).then(function() {
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = 'Copied!';
                    setTimeout(function() {
                        copyBtn.textContent = originalText;
                    }, 2000);
                }).catch(function(err) {
                    console.error('Failed to copy text: ', err);
                });
            });
        }

        if(modalShareButton) {
            modalShareButton.addEventListener('click', async () => {
                const title = 'My fx(hash) portfolio valuation';
                const valueTextContent = document.getElementById('resultsTotalValue').textContent || "N/A";
                const text = `${title}: ${valueTextContent}.`;
                const url = 'https://floorcheck.com';

                if (navigator.share && shareCanvasPreview.toBlob) {
                    shareCanvasPreview.toBlob(async (blob) => {
                        if (blob) {
                            const file = new File([blob], 'fxhash_valuation.png', { type: 'image/png' });
                            try {
                                await navigator.share({
                                    files: [file],
                                    title: title,
                                    text: text, // Text might be ignored by some platforms when files are present
                                    url: url // URL might also be ignored by some when files are present
                                });
                                console.log('Image shared successfully!');
                            } catch (error) {
                                console.error('Error sharing image:', error);
                                // Fallback to text share if image share fails
                                try {
                                    await navigator.share({ title: title, text: text, url: url });
                                } catch (e) {
                                    navigator.clipboard.writeText(`${text} ${url}`)
                                        .then(() => alert('Valuation info copied to clipboard! (Image share failed)'))
                                        .catch(err => console.error('Failed to copy to clipboard:', err));
                                }
                            }
                        } else {
                            // Blob creation failed, fallback to text share
                            try {
                                await navigator.share({ title: title, text: text, url: url });
                            } catch (e) {
                                navigator.clipboard.writeText(`${text} ${url}`)
                                    .then(() => alert('Valuation info copied to clipboard! (Image generation failed)'))
                                    .catch(err => console.error('Failed to copy to clipboard:', err));
                            }
                        }
                    }, 'image/png');
                } else {
                    // Fallback for no navigator.share or no toBlob (e.g. older browsers)
                    navigator.clipboard.writeText(`${text} ${url}`)
                        .then(() => alert('Valuation info copied to clipboard! (Sharing not fully supported)'))
                        .catch(err => console.error('Failed to copy to clipboard:', err));
                }
            });
        }

        if(modalDownloadButton) {
            modalDownloadButton.addEventListener('click', () => {
                // Ensure the canvas is drawn before download, if it wasn't already by opening the modal
                const valueTextContent = document.getElementById('resultsTotalValue').textContent || "0 ꜩ";
                drawShareImageOnCanvas(shareCanvasPreview, valueTextContent); // Re-draw to be sure

                const dataURL = shareCanvasPreview.toDataURL('image/png');
                const filename = "fxhash_portfolio_valuation.png";
                const element = document.createElement('a');
                element.setAttribute('href', dataURL);
                element.setAttribute('download', filename);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            });
        }

        function resetResultsCard() {
            document.getElementById('resultsTotalValue').innerHTML = `<div class="skeleton" style="width: 200px; height: 38px; border-radius: 4px;"></div>`;
            document.getElementById('resultsCollectedIterations').innerHTML = `<div class="skeleton" style="width: 60px; height: 17px; border-radius: 3px;"></div>`;
            document.getElementById('resultsTopArtist').innerHTML = `<div class="skeleton" style="width: 120px; height: 17px; border-radius: 3px;"></div>`;
            document.getElementById('resultsUniqueArtists').innerHTML = `<div class="skeleton" style="width: 50px; height: 17px; border-radius: 3px;"></div>`;
            document.getElementById('resultsMostValuable').innerHTML = `<div class="skeleton" style="width: 100px; height: 17px; border-radius: 3px;"></div>`;
        }

        function renderPortfolioInsights(items, totalPortfolioValue) {
            // 1. Update Total Value
            document.getElementById('resultsTotalValue').textContent = `${totalPortfolioValue.toLocaleString()} ꜩ`;

            if (!items) { // Guard against null/undefined items
                items = [];
            }

            const fxhashGalleryItems = items.filter(item => 
                item.contractName && 
                (item.contractName.toLowerCase().includes('fx(hash)') || item.contractName.toLowerCase().includes('fxhash')) &&
                item.galleryId && item.galleryId !== 'N/A'
            );
            
            // 2. Collected Iterations
            document.getElementById('resultsCollectedIterations').textContent = fxhashGalleryItems.length;

            if (fxhashGalleryItems.length === 0) {
                document.getElementById('resultsTopArtist').textContent = 'N/A';
                document.getElementById('resultsUniqueArtists').textContent = '0';
                document.getElementById('resultsMostValuable').textContent = 'N/A';
                return;
            }

            // 3. Most Collected & Unique Artists
            const artistCounts = {};
            fxhashGalleryItems.forEach(item => {
                const artistName = item.artistDisplay; // Using display name for the card
                if (artistName && artistName !== 'N/A' && artistName !== 'Unknown') {
                    artistCounts[artistName] = (artistCounts[artistName] || 0) + 1;
                }
            });

            const uniqueArtistCount = Object.keys(artistCounts).length;
            document.getElementById('resultsUniqueArtists').textContent = uniqueArtistCount;

            let maxCount = 0;
            let mostCollectedArtists = ['N/A'];
            if (uniqueArtistCount > 0) {
                mostCollectedArtists = [];
                for (const artist in artistCounts) {
                    if (artistCounts[artist] > maxCount) {
                        maxCount = artistCounts[artist];
                        mostCollectedArtists = [artist];
                    } else if (artistCounts[artist] === maxCount) {
                        mostCollectedArtists.push(artist);
                    }
                }
                document.getElementById('resultsTopArtist').textContent = mostCollectedArtists.join(', ');
            } else {
                document.getElementById('resultsTopArtist').textContent = 'N/A';
            }

            // 4. Most Valuable Artworks by Gallery Floor Price
            const itemsWithFloor = fxhashGalleryItems.filter(item => item.galleryFloorPrice !== null && item.galleryFloorPrice !== undefined);
            let maxGalleryFloor = -1;
            if (itemsWithFloor.length > 0) {
                itemsWithFloor.forEach(item => {
                    if (item.galleryFloorPrice > maxGalleryFloor) {
                        maxGalleryFloor = item.galleryFloorPrice;
                    }
                });

                if (maxGalleryFloor >= 0) {
                    document.getElementById('resultsMostValuable').textContent = `${(maxGalleryFloor / 1000000).toLocaleString()} ꜩ`;
                } else {
                    document.getElementById('resultsMostValuable').textContent = 'N/A';
                }
            } else {
                document.getElementById('resultsMostValuable').textContent = 'N/A';
            }
        }

        function logPortfolioInsights(items) {
            if (!items || items.length === 0) {
                console.log("Portfolio Insights: No items to analyze.");
                return;
            }
            console.log("--- Portfolio Insights ---"); 
            console.log(`Total Owned Tokens (all types, fetched): ${items.length}`); 

            const fxhashGalleryItems = items.filter(item => 
                item.contractName && 
                (item.contractName.toLowerCase().includes('fx(hash)') || item.contractName.toLowerCase().includes('fxhash')) &&
                item.galleryId && item.galleryId !== 'N/A' &&
                item.galleryFloorPrice !== null && item.galleryFloorPrice !== undefined
            );

            if (fxhashGalleryItems.length === 0) {
                console.log("Portfolio Insights: No fx(hash) gallery items with floor prices to analyze for further artist/value breakdown.");
                console.log("-------------------------"); 
                return;
            }

            // 1. Most Collected Artists
            const artistCounts = {};
            fxhashGalleryItems.forEach(item => {
                const artistKey = item.artistObjktAddress || item.artistDisplay;
                if (artistKey && artistKey !== 'N/A' && artistKey !== 'Unknown') {
                    artistCounts[artistKey] = (artistCounts[artistKey] || 0) + 1;
                }
            });

            let maxCount = 0;
            let mostCollectedArtists = [];
            if (Object.keys(artistCounts).length > 0) {
                const uniqueArtistCount = Object.keys(artistCounts).length;
                console.log(`Total Unique Artists (in fx(hash) gallery items): ${uniqueArtistCount}`);
                for (const artist in artistCounts) {
                    if (artistCounts[artist] > maxCount) {
                        maxCount = artistCounts[artist];
                        mostCollectedArtists = [artist];
                    } else if (artistCounts[artist] === maxCount) {
                        mostCollectedArtists.push(artist);
                    }
                }
                console.log(`Most Collected Artist(s) (from fx(hash) gallery items with ${maxCount} token(s) each):`);
                mostCollectedArtists.forEach(artist => console.log(`- ${artist}`));
            } else {
                console.log("Portfolio Insights: Could not determine most collected artists (no valid artist data).");
            }

            // 2. Most Valuable Artworks by Gallery Floor Price
            let maxGalleryFloor = -1;
            fxhashGalleryItems.forEach(item => {
                if (item.galleryFloorPrice > maxGalleryFloor) {
                    maxGalleryFloor = item.galleryFloorPrice;
                }
            });

            if (maxGalleryFloor >= 0) {
                const mostValuableArtworks = fxhashGalleryItems.filter(item => item.galleryFloorPrice === maxGalleryFloor);
                console.log(`Highest Gallery Floor Price Found: ${maxGalleryFloor / 1000000} ꜩ`);
                console.log(`Artwork(s) from Collection(s) with this Floor Price:`);
                mostValuableArtworks.forEach(artwork => {
                    console.log(`- "${artwork.title}" (Gallery ID: ${artwork.galleryId}, Artist: ${artwork.artistDisplay})`);
                });
            } else {
                console.log("Portfolio Insights: Could not determine most valuable artworks by gallery floor (no valid floor price data).");
            }
            console.log("-------------------------");
        }

        if (demoLink) {
            demoLink.addEventListener('click', (e) => {
                e.preventDefault();
                addressInput.value = 'tz1PoDdN2oyRyF6DA73zTWAWYhNL4UGr3Egj';
                fetchButton.click();
            });
        }

        // Handle address from URL or localStorage on page load
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const addressFromUrl = urlParams.get('address');
            if (addressFromUrl) {
                addressInput.value = decodeURIComponent(addressFromUrl);
                // Automatically fetch if address is in URL, but give a small delay for UI to be ready
                setTimeout(() => fetchButton.click(), 100);
            } else {
                const lastAddress = localStorage.getItem('lastFxhashAddress');
                if (lastAddress) {
                    addressInput.value = lastAddress;
                }
            }
        })();

        if (downloadStatsButton) {
            downloadStatsButton.addEventListener('click', () => {
                const widget = document.querySelector('.widget-container');
                html2canvas(widget, {
                    backgroundColor: '#121212', // Match body background
                    useCORS: true, // To handle images from other origins if any
                    scale: 4 // Render at 4x resolution for Ultra HD quality
                }).then(canvas => {
                    const dataURL = canvas.toDataURL('image/png');
                    const element = document.createElement('a');
                    element.setAttribute('href', dataURL);
                    element.setAttribute('download', 'fxtez-stats.png');
                    element.style.display = 'none';
                    document.body.appendChild(element);
                    element.click();
                    document.body.removeChild(element);
                });
            });
        }

    </script>

    <footer class="footer">
      
        <img src="fromfriends.svg" alt="From Friends Logo" class="footer-image">
        <div class="footer-sections">
            <div class="footer-section">
                <h3>Tezos Tools</h3>
                <ul class="footer-links">
                    <li><a href="https://from-friends.github.io/teztracker.html" target="_blank" rel="noopener noreferrer">TezTracker</a></li>
                    <li><a href="https://from-friends.github.io/" target="_blank" rel="noopener noreferrer">FrameToGo</a></li>
                    <li><a href="https://tiktoktezos.netlify.app/" target="_blank" rel="noopener noreferrer">TikTok for Tezos</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Contact FromFriends</h3>
                <ul class="footer-links">
                    <li><a href="https://x.com/FromFriends__" target="_blank" rel="noopener noreferrer">Follow on X</a></li>
                    <li><a href="mailto:heyfromfriends@gmail.com">Email</a></li>
                    <li><a href="https://from-friends.github.io/" target="_blank" rel="noopener noreferrer">Website</a></li>
                </ul>
            </div>
        </div>
    </footer>

</body>
</html> 
